<% layout('layout') -%>

<article class="show mt-3">
  <h2 class="mb-3"><%= listing.title %></h2>

  <!-- Map -->
  <div id="map" style="width:100%; height:320px; border-radius:8px; margin-bottom:15px; border:1px solid #e9ecef;"></div>

  <!-- Gallery -->
  <% if (Array.isArray(gallery) && gallery.length) { %>
    <div class="row g-2 mb-3">
      <% gallery.forEach(function(img){ %>
        <div class="col-6 col-md-4">
          <img class="img-fluid rounded border" src="<%= img.url %>" alt="photo">
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <p class="text-muted">No images yet.</p>
  <% } %>

  <div class="d-flex flex-wrap gap-3 align-items-center mb-2">
    <div class="fs-5 fw-semibold">$<%= listing.price %></div>
    <div class="text-muted"><i class="bi bi-geo-alt"></i> <%= listing.location %></div>
  </div>
  <p class="mb-3"><%= listing.description %></p>

  <% if (isOwner) { %>
    <div class="d-flex gap-2 mt-2 mb-4">
      <a class="btn btn-dark" href="/listings/<%= listing._id %>/edit"><i class="bi bi-pencil"></i> Edit</a>
      <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Delete this listing?');">
        <button class="btn btn-danger"><i class="bi bi-trash"></i> Delete</button>
      </form>
    </div>
  <% } %>

  <hr class="my-4">

  <!-- Reviews -->
  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <h3 class="h5 mb-3">Guest Reviews</h3>

      <% if (reviews && reviews.length) { %>
        <ul class="list-group mb-3">
          <% reviews.forEach(function(r) { %>
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <!-- Star render for existing reviews -->
                  <div class="stars-readonly mb-1" aria-label="<%= r.rating %> out of 5">
                    <% for (let i = 1; i <= 5; i++) { %>
                      <% if (i <= r.rating) { %>
                        <i class="bi bi-star-fill"></i>
                      <% } else { %>
                        <i class="bi bi-star"></i>
                      <% } %>
                    <% } %>
                  </div>
                  <div><%= r.body %></div>
                </div>

                <% if (r.canDelete) { %>
                  <form action="/listings/<%= listing._id %>/reviews/<%= r._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Delete this review?');">
                    <button class="btn btn-sm btn-danger">Delete</button>
                  </form>
                <% } %>
              </div>
            </li>
          <% }); %>
        </ul>
      <% } else { %>
        <div class="empty-state border-soft rounded-4 p-4">
          <div class="empty-icon mb-2"><i class="bi bi-chat-left-text"></i></div>
          <div class="fw-semibold mb-1">No reviews yet</div>
          <div class="text-muted small">Be the first to share your experience.</div>
        </div>
      <% } %>
    </div>

    <!-- Review form -->
    <div class="col-12 col-lg-5">
      <% if (currentUser) { %>
        <form action="/listings/<%= listing._id %>/reviews" method="POST" class="card form-card">
          <div class="card-header"><strong>Add your review</strong></div>
          <div class="card-body">
            <!-- Star rating (accessible radio group) -->
            <fieldset class="rating mb-3" aria-label="Rating out of 5">
              <!-- Note: radios are reversed so hover fills leftwards -->
              <input type="radio" name="review[rating]" id="star5" value="5" required>
              <label for="star5" title="Excellent"><i class="bi bi-star-fill"></i></label>

              <input type="radio" name="review[rating]" id="star4" value="4">
              <label for="star4" title="Good"><i class="bi bi-star-fill"></i></label>

              <input type="radio" name="review[rating]" id="star3" value="3">
              <label for="star3" title="Okay"><i class="bi bi-star-fill"></i></label>

              <input type="radio" name="review[rating]" id="star2" value="2">
              <label for="star2" title="Poor"><i class="bi bi-star-fill"></i></label>

              <input type="radio" name="review[rating]" id="star1" value="1">
              <label for="star1" title="Terrible"><i class="bi bi-star-fill"></i></label>
            </fieldset>

            <div class="mb-2">
              <label class="form-label">Your review</label>
              <textarea class="form-control" name="review[body]" rows="3" placeholder="What did you like? What could be better?" required></textarea>
            </div>

            <button class="btn btn-dark mt-2"><i class="bi bi-send"></i> Submit Review</button>
          </div>
        </form>
      <% } else { %>
        <div class="card border-soft">
          <div class="card-body">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-lock"></i>
              <div><a href="/login">Log in</a> to write a review.</div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</article>

<!-- MAPBOX CSS/JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<script>
(function() {
  var geometry = <%- JSON.stringify(geometry || null) %>;
  var locText  = <%- JSON.stringify(locText || "") %>;
  var titleTxt = <%- JSON.stringify(titleTxt || "") %>;
  var MAPBOX_TOKEN = "<%= typeof mapToken !== 'undefined' ? mapToken : '' %>";

  if (MAPBOX_TOKEN && geometry && Array.isArray(geometry.coordinates)) {
    mapboxgl.accessToken = MAPBOX_TOKEN;
    var lng = Number(geometry.coordinates[0]);
    var lat = Number(geometry.coordinates[1]);

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [lng, lat],
      zoom: 12
    });

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    new mapboxgl.Marker()
      .setLngLat([lng, lat])
      .setPopup(new mapboxgl.Popup().setHTML('<strong>' + titleTxt + '</strong><br>' + locText))
      .addTo(map);
  } else {
    var el = document.getElementById('map');
    if (el) el.innerHTML = '<div style="padding:12px;border:1px solid #eee;border-radius:8px;background:#fff;">No map data or token for this listing yet.</div>';
  }
})();
</script>











